name: Secret Scan - TruffleHog

on:
  push:
    branches:
      - main
      - trufflehog-test

jobs:
  trufflehog-scan:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh
          sudo mv ./bin/trufflehog /usr/local/bin/

      - name: Prepare test secret
        run: echo "TEST_API_KEY=123456" >> .env

      - name: Run TruffleHog and generate SARIF
        run: |
          echo "Executando TruffleHog..."
          trufflehog filesystem . \
            --regex \
            --json-file results.json \
            --debug || echo "TruffleHog finalizado com código $?"
          
          # Converte JSON para SARIF mínimo compatível com DefectDojo
          if [ ! -f results.sarif ]; then
            if [ -f results.json ]; then
              jq -n --argjson findings "$(cat results.json)" \
                '{version:"2.1.0", runs:[{tool:{driver:{name:"trufflehog"}}, results:$findings}]}' \
                > results.sarif
              echo "SARIF gerado a partir do JSON."
            else
              echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"trufflehog"}},"results":[]}]}'> results.sarif
              echo "SARIF mínimo criado (vazio)."
            fi
          fi

      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-sarif
          path: results.sarif
